<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»é¤ç³»çµ±<ç¥¥å’Œåœ’æ´»é­šé¤å»³></title>
    <style>
        body { font-family: sans-serif; background: #ffffff; margin: 0; padding-bottom: 120px; font-size: 18px; color: #333; }
        
        /* å§“åè¼¸å…¥é  */
        #name-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #name-input { width: 85%; padding: 15px; font-size: 24px; border: 2px solid #ddd; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .btn-start { width: 85%; padding: 18px; background: #28a745; color: white; border: none; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; }

        /* é ‚éƒ¨å°è¦½ */
        .header { background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .table-info { padding: 15px; background: #28a745; color: white; font-weight: bold; font-size: 20px; text-align: center; user-select: none; }
        .category-container { display: flex; overflow-x: auto; background: #0093c4; white-space: nowrap; }
        .cat-tab { padding: 15px 20px; color: white; font-size: 18px; cursor: pointer; flex-shrink: 0; }
        .cat-tab.active { background: #8bc34a; font-weight: bold; }

        /* èœå–®å¡ç‰‡ (åŠ å¤§å­—é«”) */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .menu-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .item-name { font-size: 22px; font-weight: bold; color: #0076a3; margin-bottom: 5px; height: 60px; overflow: hidden; }
        .item-price { font-size: 20px; color: #f57c00; font-weight: bold; }
        .btn-qty { width: 45px; height: 45px; border-radius: 8px; border: 1px solid #ddd; background: #fff; font-size: 24px; font-weight: bold; }

        /* åº•éƒ¨ç¸½é¡é¡¯ç¤º */
        .footer { position: fixed; bottom: 0; width: 100%; background: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; z-index: 200; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        
        /* è³¼ç‰©è»Š FAB */
        #cart-fab { position: fixed; bottom: 100px; right: 20px; background: #ff9800; color: white; width: 65px; height: 65px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 150; cursor: pointer; }
        #cart-badge { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; display: flex; align-items: center; justify-content: center; }

        /* è³¼ç‰©è»Šå½ˆå‡ºè¦–çª— */
        #cart-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 85%; max-height: 75%; border-radius: 20px; padding: 25px; overflow-y: auto; }
        .cart-item-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 20px; }

        /* é€å‡ºæˆåŠŸé®ç½© */
        #ordered-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 999; text-align: center; padding-top: 150px; }
    </style>
</head>
<body>

<div id="name-screen">
    <h2 id="long-press-target" style="font-size: 30px; user-select: none;">æ­¡è¿å…‰è‡¨</h2>
    <p style="color: #666; margin-bottom: 30px;">è«‹è¼¸å…¥å§“åæˆ–æ¡Œè™Ÿé–‹å§‹é»é¤</p>
    <input type="text" id="name-input" placeholder="æ‚¨çš„å§“åæˆ–æ¡Œè™Ÿ">
    <button class="btn-start" onclick="start()">é–‹å§‹é»é¤</button>
</div>

<div id="ordered-mask">
    <div style="font-size: 40px; margin-bottom: 20px;">âœ…</div>
    <div style="font-size: 28px; font-weight: bold; color: #28a745; margin-bottom: 15px;">è¨‚å–®å·²é€å‡º</div>
    <p style="font-size: 22px; color: #666;">è«‹ç¨å€™ï¼Œé¤é»è£½ä½œä¸­...</p>
    <p style="font-size: 15px; color: #ccc; margin-top: 50px;">(å¦‚éœ€æ›´æ”¹é¤é»è«‹æ´½æ«ƒå°è©¢å•)</p>
</div>

<div class="header">
    <div id="table-display" class="table-info">è®€å–ä¸­...</div>
    <div id="category-box" class="category-container"></div>
</div>

<div id="menu-display" class="menu-grid"></div>

<div id="cart-fab" onclick="showCartModal()">
    ğŸ›’<div id="cart-badge">0</div>
</div>

<div id="cart-modal">
    <div class="modal-content">
        <h2 style="text-align: center; margin-top: 0; color: #333;">ğŸ›’ é»é¤å…§å®¹æ ¸å°</h2>
        <div id="cart-items-list" style="margin: 20px 0;"></div>
        <div style="font-size: 24px; font-weight: bold; text-align: right; color: #d32f2f; margin-bottom: 25px;">
            ç¸½é¡ï¼š$<span id="modal-total-price">0</span>
        </div>
        <div style="display: flex; gap: 15px;">
            <button onclick="closeCartModal()" style="flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #ddd; background: #f8f9fa; font-size: 18px;">ç¹¼çºŒé»é¤</button>
            <button id="order-btn-final" onclick="submitOrder()" style="flex: 2; padding: 15px; border-radius: 10px; border: none; background: #28a745; color: white; font-size: 20px; font-weight: bold;">ç¢ºå®šé€å‡º</button>
        </div>
    </div>
</div>

<div class="footer">
    <div style="font-size: 22px; font-weight: bold;">ç›®å‰ç¸½é¡ï¼š$<span id="total-price">0</span></div>
    <div style="color: #888; font-size: 14px;">é»æ“Šå³ä¸‹è³¼ç‰©è»Šé€å‡ºè¨‚å–®</div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzxR4PDIfLlUPpwCAraPsK7qAbbXMU1uRMNw1fOfMSvau5jbkSdgjQQVx01c9_AvRB6/exec"; 
    let menuData = [], cart = {}, activeCat = "", userName = "";
    const table = new URLSearchParams(window.location.search).get('table') || "ç¾å ´";

    // --- é•·æŒ‰éš±è—é‡è¨­é‚è¼¯ ---
    let pressTimer;
    function handleStart() {
        pressTimer = window.setTimeout(function() {
            if(confirm("ã€ç®¡ç†å“¡æ¨¡å¼ã€‘æ˜¯å¦è¦é‡è¨­ç³»çµ±ä¸¦æ¸…é™¤æœ¬åœ°ç´€éŒ„ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }, 3000); 
    }
    function handleEnd() { clearTimeout(pressTimer); }

    window.onload = () => {
        if (localStorage.getItem('hasOrdered') === 'true') {
            const mask = document.getElementById('ordered-mask');
            mask.style.display = 'block';
            mask.onmousedown = handleStart; mask.ontouchstart = handleStart;
            mask.onmouseup = handleEnd; mask.ontouchend = handleEnd;
        }
        const target = document.getElementById('long-press-target');
        target.onmousedown = handleStart; target.ontouchstart = handleStart;
        target.onmouseup = handleEnd; target.ontouchend = handleEnd;
    };

    function start() {
        userName = document.getElementById('name-input').value.trim();
        if (!userName) return alert("è«‹è¼¸å…¥å§“å");
        document.getElementById('name-screen').style.display = 'none';
        
        const tableDisp = document.getElementById('table-display');
        tableDisp.innerText = `æ¡Œè™Ÿï¼š${table} | é¡§å®¢ï¼š${userName}`;
        tableDisp.onmousedown = handleStart; tableDisp.ontouchstart = handleStart;
        tableDisp.onmouseup = handleEnd; tableDisp.ontouchend = handleEnd;
        
        fetch(API_URL).then(res => res.json()).then(data => {
            menuData = data;
            const cats = [...new Set(data.map(i => i.category))];
            activeCat = cats[0];
            renderTabs(cats);
            renderMenu();
        });
    }

    function renderTabs(cats) {
        const box = document.getElementById('category-box'); box.innerHTML = "";
        cats.forEach(c => {
            const d = document.createElement('div');
            d.className = `cat-tab ${c === activeCat ? 'active' : ''}`;
            d.innerText = c;
            d.onclick = () => { 
                activeCat = c; renderMenu(); 
                document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
                d.classList.add('active'); 
            };
            box.appendChild(d);
        });
    }

    function renderMenu() {
        const container = document.getElementById('menu-display'); container.innerHTML = "";
        menuData.filter(i => i.category === activeCat).forEach(item => {
            const card = document.createElement('div');
            card.className = 'menu-card';
            card.innerHTML = `<div class="item-name">${item.name}</div><div class="item-price">$${item.price}</div>
            <div style="display:flex;justify-content:flex-end;align-items:center;margin-top:10px;">
                <button class="btn-qty" onclick="updateQty('${item.name}',-1)">-</button>
                <span id="q-${item.name}" style="margin:0 15px; font-size:22px; font-weight:bold;">${cart[item.name]||0}</span>
                <button class="btn-qty" onclick="updateQty('${item.name}',1)">+</button>
            </div>`;
            container.appendChild(card);
        });
    }

    function updateQty(n, d) {
        cart[n] = (cart[n]||0)+d; if(cart[n]<=0) delete cart[n];
        const span = document.getElementById(`q-${n}`); if(span) span.innerText = cart[n]||0;
        
        let total = 0, count = 0;
        for(let name in cart) {
            const info = menuData.find(m => m.name === name);
            if(info) { total += info.price * cart[name]; count += cart[name]; }
        }
        document.getElementById('total-price').innerText = total;
        
        const fab = document.getElementById('cart-fab');
        if(count > 0) {
            fab.style.display = 'flex';
            document.getElementById('cart-badge').innerText = count;
        } else {
            fab.style.display = 'none';
        }
    }

    // é¡¯ç¤ºè³¼ç‰©è»Šæ¸…å–®å½ˆçª—
    function showCartModal() {
        const listContainer = document.getElementById('cart-items-list');
        listContainer.innerHTML = "";
        let total = 0;
        for (let name in cart) {
            const info = menuData.find(m => m.name === name);
            if (info) {
                const sub = info.price * cart[name]; total += sub;
                const div = document.createElement('div');
                div.className = 'cart-item-row';
                div.innerHTML = `<span>${name} x ${cart[name]}</span><span style="color:#f57c00">$${sub}</span>`;
                listContainer.appendChild(div);
            }
        }
        document.getElementById('modal-total-price').innerText = total;
        document.getElementById('cart-modal').style.display = 'flex';
    }

    function closeCartModal() { document.getElementById('cart-modal').style.display = 'none'; }

    function submitOrder() {
        if(!confirm("ç¢ºå®šé€å‡ºè¨‚å–®ï¼Ÿé€å‡ºå¾Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ã€‚")) return;
        const items = [];
        for(let n in cart) {
            const info = menuData.find(m => m.name === n);
            items.push({name: n, count: cart[n], category: info.category});
        }
        
        // ç¦ç”¨æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
        document.getElementById('order-btn-final').disabled = true;
        document.getElementById('order-btn-final').innerText = "é€å‡ºä¸­...";

        fetch(API_URL, {
            method: "POST", 
            body: JSON.stringify({table: `${userName} (${table})`, items, total: document.getElementById('modal-total-price').innerText})
        })
        .then(() => { 
            localStorage.setItem('hasOrdered', 'true'); 
            location.reload(); 
        })
        .catch(err => {
            alert("é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
            document.getElementById('order-btn-final').disabled = false;
            document.getElementById('order-btn-final').innerText = "ç¢ºå®šé€å‡º";
        });
    }
</script>
</body>
</html>