<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šé»é¤ç³»çµ±</title>
    <style>
        /* 1. å…§å®¹å­—é«”ç¶­æŒå¤§å­—é«” */
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 120px; font-size: 18px; }
        
        .header { background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .table-info { padding: 12px; background: #28a745; color: white; font-weight: bold; font-size: 18px; text-align: center; }
        
        /* 2. åˆ†é¡æ¨™é¡Œå›å¾©æˆåŸä¾†çš„å¤§å° (15px) */
        .category-container { display: grid; grid-template-columns: repeat(4, 1fr); background: #0093c4; }
        .cat-tab { padding: 12px 5px; color: white; text-align: center; font-size: 15px; cursor: pointer; border: 0.5px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        .cat-tab.active { background: #8bc34a; font-weight: bold; }

        /* èœå–®å¡ç‰‡ç¶­æŒå¤§å­—é«” */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
        .menu-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .item-name { color: #0076a3; font-weight: bold; font-size: 22px; margin-bottom: 8px; }
        .item-price { color: #f57c00; font-weight: bold; font-size: 20px; }
        
        /* æ§åˆ¶æŒ‰éˆ•åŠ å¤§ */
        .controls { display: flex; align-items: center; justify-content: flex-end; margin-top: 15px; }
        .btn-qty { width: 45px; height: 45px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; font-size: 24px; font-weight: bold; }
        .qty-val { margin: 0 15px; font-weight: bold; color: #333; font-size: 22px; }

        /* åº•éƒ¨æ¬„ä½ */
        .footer { position: fixed; bottom: 0; width: 100%; background: #fff; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        #order-btn { background: #28a745; color: white; border: none; padding: 15px 35px; border-radius: 8px; font-size: 22px; font-weight: bold; cursor: pointer; }
        #order-btn:disabled { background: #ccc; }
        
        /* å·²é»é¤æç¤ºé®ç½© */
        #ordered-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; z-index: 999; text-align: center; padding-top: 150px; }
    </style>
</head>
<body>

<div id="ordered-mask">
    <div style="font-size: 30px; margin-bottom: 20px;">ğŸ“ è¨‚å–®å·²é€å‡ºæˆåŠŸï¼</div>
    <div style="font-size: 20px; color: #ccc;">è‹¥éœ€åŠ é»è«‹æ´½æœå‹™äººå“¡</div>
    <button onclick="localStorage.removeItem('hasOrdered'); location.reload();" style="margin-top: 50px; background: none; border: 1px solid #555; color: #555; padding: 5px 10px;">(è€é—†æ¸¬è©¦ç”¨ï¼šæ¸…é™¤é™åˆ¶)</button>
</div>

<div class="header">
    <div id="table-display" class="table-info">æ¡Œè™Ÿï¼šç¢ºèªä¸­...</div>
    <div id="category-box" class="category-container"></div>
</div>

<div id="menu-display" class="menu-grid">
    <div style="grid-column: span 2; text-align: center; padding: 40px;">è®€å–ä¸­...</div>
</div>

<div class="footer">
    <div style="font-size: 22px; font-weight: bold;">ç¸½è¨ˆï¼š$<span id="total-price">0</span></div>
    <button id="order-btn" disabled onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzxR4PDIfLlUPpwCAraPsK7qAbbXMU1uRMNw1fOfMSvau5jbkSdgjQQVx01c9_AvRB6/exec"; 
    let menuData = [];
    let cart = {};
    let activeCat = "";
    const table = new URLSearchParams(window.location.search).get('table') || "ç¾å ´";

    window.onload = () => {
        // æª¢æŸ¥æ˜¯å¦é»éé¤
        if (localStorage.getItem('hasOrdered') === 'true') {
            document.getElementById('ordered-mask').style.display = 'block';
            return;
        }

        document.getElementById('table-display').innerText = "æ‚¨çš„æ¡Œè™Ÿï¼š" + table;
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                menuData = data;
                const cats = [...new Set(data.map(i => i.category))];
                activeCat = cats[0];
                renderTabs(cats);
                renderMenu();
            })
            .catch(err => {
                // å¦‚æœè®€ä¸åˆ°èœå–®ï¼Œé€šå¸¸æ˜¯ GAS ç¶²å€æˆ–æ¬Šé™å•é¡Œ
                document.getElementById('menu-display').innerHTML = '<div style="grid-column: span 2; color: red; text-align:center; padding: 20px;">ç„¡æ³•è®€å–èœå–®ï¼Œè«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚</div>';
            });
    };

    function renderTabs(cats) {
        const box = document.getElementById('category-box');
        box.innerHTML = "";
        cats.forEach(c => {
            const d = document.createElement('div');
            d.className = `cat-tab ${c === activeCat ? 'active' : ''}`;
            d.innerText = c;
            d.onclick = () => {
                activeCat = c;
                document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
                d.classList.add('active');
                renderMenu();
            };
            box.appendChild(d);
        });
    }

    function renderMenu() {
        const container = document.getElementById('menu-display');
        container.innerHTML = "";
        menuData.filter(i => i.category === activeCat).forEach(item => {
            const card = document.createElement('div');
            card.className = 'menu-card';
            card.innerHTML = `
                <div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price}</div>
                </div>
                <div class="controls">
                    <button class="btn-qty" onclick="updateQty('${item.name}', -1)">-</button>
                    <span class="qty-val" id="q-${item.name}">${cart[item.name] || 0}</span>
                    <button class="btn-qty" onclick="updateQty('${item.name}', 1)">+</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function updateQty(name, delta) {
        cart[name] = (cart[name] || 0) + delta;
        if (cart[name] < 0) cart[name] = 0;
        document.getElementById(`q-${name}`).innerText = cart[name];
        
        let total = 0;
        menuData.forEach(i => { if(cart[i.name]) total += i.price * cart[i.name]; });
        document.getElementById('total-price').innerText = total;
        document.getElementById('order-btn').disabled = total === 0;
    }

    function submitOrder() {
        if (!confirm("ç¢ºå®šè¦é€å‡ºè¨‚å–®å—ï¼Ÿé€å‡ºå¾Œä¸å¯ä¿®æ”¹ã€‚")) return;

        const btn = document.getElementById('order-btn');
        btn.disabled = true;
        btn.innerText = "å‚³é€ä¸­...";

        const items = menuData.filter(i => cart[i.name] > 0).map(i => ({
            name: i.name, count: cart[i.name], category: i.category
        }));

        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ table, items, total: document.getElementById('total-price').innerText })
        })
        .then(() => {
            localStorage.setItem('hasOrdered', 'true');
            alert("è¨‚å–®å·²é€å‡ºï¼");
            location.reload();
        })
        .catch(err => {
            alert("é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS æ¬Šé™ã€‚");
            btn.disabled = false;
            btn.innerText = "é€å‡ºè¨‚å–®";
        });
    }
</script>
</body>
</html>